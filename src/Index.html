<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>ReVisor - Revision Analysis Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <?!= include('Stylesheet'); ?>
  </head>
  <body>
    <div id="loading-fallback" style="padding: 2rem; text-align: center; font-family: sans-serif;">
      <h2 style="color: #1a73e8;">ReVisor Studio</h2>
      <p id="loading-status">Initializing Workspace...</p>
      <div style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>
    
    <div class="app-wrapper hidden" id="main-app-container">
      <!-- HEADER: Identification & Main Controls -->
      <header class="app-header">
        <div class="header-logo">
          <h1 class="headline-small" style="margin:0; color: var(--md-sys-color-primary);">ReVisor</h1>
        </div>
        <div class="header-inputs" style="display:flex; gap:16px; align-items:center;">
          <input type="text" id="doc-id-input" placeholder="Paste Google Doc ID or URL..." style="width: 320px;" />
          <button id="folder-picker-btn" class="btn"><span class="material-symbols-outlined">folder_open</span>Folder</button>
          <button id="analyze-btn" class="btn primary"><span class="material-symbols-outlined">analytics</span>Start Analysis</button>
        </div>
        <div id="status-message" class="status-bar body-medium" style="color: var(--md-sys-color-secondary);">Ready</div>
      </header>

      <div class="main-container">
        <!-- SIDEBAR: Context, AI Insights, & History -->
        <aside class="sidebar">
          
          <!-- Database Section -->
          <div class="sidebar-section" id="database-section">
            <h3 style="display:flex; justify-content:space-between; align-items:center;">
               Analytics Database
               <button id="connect-db-btn" class="btn" style="padding: 0 12px; height: 28px; font-size: 12px;"><span class="material-symbols-outlined" style="font-size:16px;">dns</span>Manage</button>
            </h3>
            <div id="db-info" class="sidebar-meta" style="font-size: 12px; color: var(--md-sys-color-secondary); display:none;">
               Connected: <a id="db-link" href="#" target="_blank" style="color: var(--md-sys-color-primary);">...</a>
               <div style="margin-top: 8px;">
                  Active Unit: <select id="active-unit-tab"></select>
               </div>
            </div>
            <div id="db-prompt" style="font-size: 12px; color: var(--md-sys-color-secondary); text-align:center; padding: 8px;">
               No database connected. 
            </div>
          </div>

          <!-- Criteria Input -->
          <div class="sidebar-section">
            <h3>Rubric / Analysis Focus</h3>
            <textarea id="rubric-input" placeholder="Optional: Criteria for Gemini to evaluate (e.g. usage of sources, shift in complexity, etc.)"></textarea>
          </div>

          <!-- AI Summary Panel -->
          <div id="ai-insights-panel" class="sidebar-section ai-panel hidden">
            <h3>AI Insights</h3>
            <div id="ai-content">
              <div class="placeholder" style="color:#888; font-size:0.85rem;">Analysis results will appear here.</div>
            </div>
          </div>

          <!-- History List -->
          <div class="sidebar-section" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h3 style="margin:0;">Revision History</h3>
              <button id="jump-latest-btn" class="btn" style="padding: 0 12px; height: 28px; font-size: 12px;"><span class="material-symbols-outlined" style="font-size:16px;">skip_next</span>Latest</button>
            </div>
            <div id="document-list" style="flex:1; overflow-y:auto;">
              <div class="empty-state" style="color:var(--md-sys-color-secondary); font-size:14px; text-align:center; padding-top:24px;">No document loaded.</div>
            </div>
          </div>

        </aside>

        <!-- MAIN STAGE: Document Display & Playback -->
        <main class="stage">
          
          <!-- Overlay for initial loading -->
          <div id="progress-overlay" class="progress-overlay hidden">
            <div class="progress-card">
              <h3 id="progress-step" style="margin-top:0;">Analyzing Process...</h3>
              <div class="progress-mini-bar">
                <div id="progress-bar-fill" class="progress-fill"></div>
              </div>
              <p id="progress-detail">Fetching history...</p>
            </div>
          </div>

          <!-- Document Content Scroller -->
          <div class="document-scroller">
            <div id="paper-content" class="paper">
              <div class="placeholder" style="text-align:center; padding-top: 100px; color: #888;">
                <h2>Welcome to ReVisor</h2>
                <p>Paste a Google Doc ID or URL to see the iterative writing process.</p>
              </div>
            </div>
          </div>

          <!-- Playback Bar Sticky at Bottom -->
          <footer class="playback-bar">
             <button id="play-pause-btn" class="btn primary" style="border-radius: 50%; width: 48px; height: 48px; padding:0; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"><span class="material-symbols-outlined" style="font-size:24px;">play_arrow</span></button>
             
             <div style="flex:1; display:flex; flex-direction:column; gap:4px;">
               <input type="range" id="timeline-slider" min="0" max="0" value="0" disabled style="width:100%; accent-color: var(--md-sys-color-primary);" />
               <div style="display:flex; justify-content:space-between; font-size: 12px; color: var(--md-sys-color-secondary);">
                  <span id="current-rev-info">Revision 0 of 0</span>
                  <span id="current-rev-date">--</span>
               </div>
             </div>

             <div class="speed-control">
                <select id="playback-speed" class="btn" style="height: 36px;">
                   <option value="2000">0.5x</option>
                   <option value="1000" selected>1x</option>
                   <option value="400">2.5x</option>
                   <option value="150">5x</option>
                </select>
             </div>
          </footer>

        </main>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121111/diff_match_patch.js"></script>
    <?!= include('JavaScript'); ?>
  </body>
</html>
